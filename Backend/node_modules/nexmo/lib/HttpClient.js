"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

var https = require("https");
var http = require("http");
var querystring = require("querystring");

var HttpClient = function () {
  function HttpClient(options, credentials) {
    _classCallCheck(this, HttpClient);

    this.credentials = credentials;
    this.host = options.host || "rest.nexmo.com";
    this.port = options.port || 443;
    this.https = options.https || https;
    this.http = options.http || http;
    this.headers = {
      "Content-Type": "application/x-www-form-urlencoded",
      Accept: "application/json"
    };
    this.logger = options.logger;

    if (options.userAgent) {
      this.headers["User-Agent"] = options.userAgent;
    }
  }

  _createClass(HttpClient, [{
    key: "request",
    value: function request(endpoint, method, callback) {
      var _this = this;

      if (typeof method === "function") {
        callback = method;
        endpoint.method = endpoint.method || "GET";
      } else if (typeof method !== "undefined") {
        endpoint.method = method;
      }

      if (endpoint.method === "POST" || endpoint.method === "DELETE") {
        // TODO: verify the following fix is required
        // Fix broken due ot 411 Content-Length error now sent by Nexmo API
        // PL 2016-Sept-6 - commented out Content-Length 0
        // headers['Content-Length'] = 0;
      }
      var options = {
        host: endpoint.host ? endpoint.host : this.host,
        port: this.port,
        path: endpoint.path,
        method: endpoint.method,
        headers: Object.assign({}, this.headers)
      };

      // Allow existing headers to be overridden
      // Allow new headers to be added
      if (endpoint.headers) {
        Object.keys(endpoint.headers).forEach(function (key) {
          options.headers[key] = endpoint.headers[key];
        });
      }

      this.logger.info("Request:", options, "\nBody:", endpoint.body);
      var request;

      if (options.port === 443) {
        request = this.https.request(options);
      } else {
        request = http.request(options);
      }

      request.end(endpoint.body);

      // Keep an array of String or Buffers,
      // depending on content type (binary or JSON) of response
      var responseData = [];

      request.on("response", function (response) {
        var isBinary = response.headers["content-type"] === "application/octet-stream";
        if (!isBinary) {
          response.setEncoding("utf8");
        }

        response.on("data", function (chunk) {
          responseData.push(chunk);
        });

        response.on("end", function () {
          _this.logger.info("response ended:", response.statusCode);
          if (callback) {
            if (isBinary) {
              responseData = Buffer.concat(responseData);
            }

            _this.__parseResponse(response, responseData, endpoint.method, callback);
          }
        });
        response.on("close", function (e) {
          _this.logger.error("problem with API request detailed stacktrace below ");
          _this.logger.error(e);
          callback(e);
        });
      });
      request.on("error", function (e) {
        _this.logger.error("problem with API request detailed stacktrace below ");
        _this.logger.error(e);
        callback(e);
      });
    }
  }, {
    key: "__parseResponse",
    value: function __parseResponse(httpResponse, data, method, callback) {
      var isArrayOrBuffer = data instanceof Array || data instanceof Buffer;
      if (!isArrayOrBuffer) {
        throw new Error("data should be of type Array or Buffer");
      }

      var status = httpResponse.statusCode;
      var headers = httpResponse.headers;

      var response = null;
      var error = null;

      try {
        if (status >= 500) {
          error = { message: "Server Error", statusCode: status };
        } else if (httpResponse.headers["content-type"] === "application/octet-stream") {
          response = data;
        } else if (status === 429) {
          // 429 does not return a parsable body
          if (!headers["retry-after"]) {
            // retry based on allowed per second
            var retryAfterMillis = method === "POST" ? 1000 / 2 : 1000 / 5;
            headers["retry-after"] = retryAfterMillis;
          }
          error = { body: data.join("") };
        } else if (status === 204) {
          response = null;
        } else if (status >= 400 || status < 200) {
          error = { body: JSON.parse(data.join("")), headers: headers };
        } else if (method !== "DELETE") {
          response = JSON.parse(data.join(""));
        } else {
          response = data;
        }
      } catch (parseError) {
        this.logger.error(parseError);
        this.logger.error("could not convert API response to JSON, above error is ignored and raw API response is returned to client");
        this.logger.error("Raw Error message from API ");
        this.logger.error("\"" + data + "\"");

        error = {
          status: status,
          message: "The API response could not be parsed.",
          body: data.join(""),
          parseError: parseError
        };
      }

      if (error) {
        error.statusCode = status;
        error.headers = headers;
      }

      if (typeof callback === "function") {
        callback(error, response);
      }
    }
  }, {
    key: "_addLimitedAccessMessageToErrors",
    value: function _addLimitedAccessMessageToErrors(callback, limitedAccessStatus) {
      return function (err, data) {
        if (err && err.status == limitedAccessStatus) {
          err._INFO_ = "This endpoint may need activating on your account. Please email support@nexmo.com for more information";
        }

        return callback(err, data);
      };
    }
  }, {
    key: "get",
    value: function get(path, params, callback) {
      params = params || {};
      params["api_key"] = this.credentials.apiKey;
      params["api_secret"] = this.credentials.apiSecret;

      path = path + "?" + querystring.stringify(params);

      this.request({ path: path }, "GET", callback);
    }
  }, {
    key: "post",
    value: function post(path, params, callback) {
      var qs = {
        api_key: this.credentials.apiKey,
        api_secret: this.credentials.apiSecret
      };

      var joinChar = "?";
      if (path.indexOf(joinChar) !== -1) {
        joinChar = "&";
      }

      path = path + joinChar + querystring.stringify(qs);

      this.request({ path: path, body: querystring.stringify(params) }, "POST", callback);
    }
  }, {
    key: "postUseQueryString",
    value: function postUseQueryString(path, params, callback) {
      params = params || {};
      params["api_key"] = this.credentials.apiKey;
      params["api_secret"] = this.credentials.apiSecret;

      path = path + "?" + querystring.stringify(params);

      this.request({ path: path }, "POST", callback);
    }
  }]);

  return HttpClient;
}();

exports.default = HttpClient;
module.exports = exports["default"];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9IdHRwQ2xpZW50LmpzIl0sIm5hbWVzIjpbImh0dHBzIiwicmVxdWlyZSIsImh0dHAiLCJxdWVyeXN0cmluZyIsIkh0dHBDbGllbnQiLCJvcHRpb25zIiwiY3JlZGVudGlhbHMiLCJob3N0IiwicG9ydCIsImhlYWRlcnMiLCJBY2NlcHQiLCJsb2dnZXIiLCJ1c2VyQWdlbnQiLCJlbmRwb2ludCIsIm1ldGhvZCIsImNhbGxiYWNrIiwicGF0aCIsIk9iamVjdCIsImFzc2lnbiIsImtleXMiLCJmb3JFYWNoIiwia2V5IiwiaW5mbyIsImJvZHkiLCJyZXF1ZXN0IiwiZW5kIiwicmVzcG9uc2VEYXRhIiwib24iLCJpc0JpbmFyeSIsInJlc3BvbnNlIiwic2V0RW5jb2RpbmciLCJwdXNoIiwiY2h1bmsiLCJzdGF0dXNDb2RlIiwiQnVmZmVyIiwiY29uY2F0IiwiX19wYXJzZVJlc3BvbnNlIiwiZXJyb3IiLCJlIiwiaHR0cFJlc3BvbnNlIiwiZGF0YSIsImlzQXJyYXlPckJ1ZmZlciIsIkFycmF5IiwiRXJyb3IiLCJzdGF0dXMiLCJtZXNzYWdlIiwicmV0cnlBZnRlck1pbGxpcyIsImpvaW4iLCJKU09OIiwicGFyc2UiLCJwYXJzZUVycm9yIiwibGltaXRlZEFjY2Vzc1N0YXR1cyIsImVyciIsIl9JTkZPXyIsInBhcmFtcyIsImFwaUtleSIsImFwaVNlY3JldCIsInN0cmluZ2lmeSIsInFzIiwiYXBpX2tleSIsImFwaV9zZWNyZXQiLCJqb2luQ2hhciIsImluZGV4T2YiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFBQSxJQUFJQSxRQUFRQyxRQUFRLE9BQVIsQ0FBWjtBQUNBLElBQUlDLE9BQU9ELFFBQVEsTUFBUixDQUFYO0FBQ0EsSUFBSUUsY0FBY0YsUUFBUSxhQUFSLENBQWxCOztJQUVNRyxVO0FBQ0osc0JBQVlDLE9BQVosRUFBcUJDLFdBQXJCLEVBQWtDO0FBQUE7O0FBQ2hDLFNBQUtBLFdBQUwsR0FBbUJBLFdBQW5CO0FBQ0EsU0FBS0MsSUFBTCxHQUFZRixRQUFRRSxJQUFSLElBQWdCLGdCQUE1QjtBQUNBLFNBQUtDLElBQUwsR0FBWUgsUUFBUUcsSUFBUixJQUFnQixHQUE1QjtBQUNBLFNBQUtSLEtBQUwsR0FBYUssUUFBUUwsS0FBUixJQUFpQkEsS0FBOUI7QUFDQSxTQUFLRSxJQUFMLEdBQVlHLFFBQVFILElBQVIsSUFBZ0JBLElBQTVCO0FBQ0EsU0FBS08sT0FBTCxHQUFlO0FBQ2Isc0JBQWdCLG1DQURIO0FBRWJDLGNBQVE7QUFGSyxLQUFmO0FBSUEsU0FBS0MsTUFBTCxHQUFjTixRQUFRTSxNQUF0Qjs7QUFFQSxRQUFJTixRQUFRTyxTQUFaLEVBQXVCO0FBQ3JCLFdBQUtILE9BQUwsQ0FBYSxZQUFiLElBQTZCSixRQUFRTyxTQUFyQztBQUNEO0FBQ0Y7Ozs7NEJBRU9DLFEsRUFBVUMsTSxFQUFRQyxRLEVBQVU7QUFBQTs7QUFDbEMsVUFBSSxPQUFPRCxNQUFQLEtBQWtCLFVBQXRCLEVBQWtDO0FBQ2hDQyxtQkFBV0QsTUFBWDtBQUNBRCxpQkFBU0MsTUFBVCxHQUFrQkQsU0FBU0MsTUFBVCxJQUFtQixLQUFyQztBQUNELE9BSEQsTUFHTyxJQUFJLE9BQU9BLE1BQVAsS0FBa0IsV0FBdEIsRUFBbUM7QUFDeENELGlCQUFTQyxNQUFULEdBQWtCQSxNQUFsQjtBQUNEOztBQUVELFVBQUlELFNBQVNDLE1BQVQsS0FBb0IsTUFBcEIsSUFBOEJELFNBQVNDLE1BQVQsS0FBb0IsUUFBdEQsRUFBZ0U7QUFDOUQ7QUFDQTtBQUNBO0FBQ0E7QUFDRDtBQUNELFVBQUlULFVBQVU7QUFDWkUsY0FBTU0sU0FBU04sSUFBVCxHQUFnQk0sU0FBU04sSUFBekIsR0FBZ0MsS0FBS0EsSUFEL0I7QUFFWkMsY0FBTSxLQUFLQSxJQUZDO0FBR1pRLGNBQU1ILFNBQVNHLElBSEg7QUFJWkYsZ0JBQVFELFNBQVNDLE1BSkw7QUFLWkwsaUJBQVNRLE9BQU9DLE1BQVAsQ0FBYyxFQUFkLEVBQWtCLEtBQUtULE9BQXZCO0FBTEcsT0FBZDs7QUFRQTtBQUNBO0FBQ0EsVUFBSUksU0FBU0osT0FBYixFQUFzQjtBQUNwQlEsZUFBT0UsSUFBUCxDQUFZTixTQUFTSixPQUFyQixFQUE4QlcsT0FBOUIsQ0FBc0MsVUFBU0MsR0FBVCxFQUFjO0FBQ2xEaEIsa0JBQVFJLE9BQVIsQ0FBZ0JZLEdBQWhCLElBQXVCUixTQUFTSixPQUFULENBQWlCWSxHQUFqQixDQUF2QjtBQUNELFNBRkQ7QUFHRDs7QUFFRCxXQUFLVixNQUFMLENBQVlXLElBQVosQ0FBaUIsVUFBakIsRUFBNkJqQixPQUE3QixFQUFzQyxTQUF0QyxFQUFpRFEsU0FBU1UsSUFBMUQ7QUFDQSxVQUFJQyxPQUFKOztBQUVBLFVBQUluQixRQUFRRyxJQUFSLEtBQWlCLEdBQXJCLEVBQTBCO0FBQ3hCZ0Isa0JBQVUsS0FBS3hCLEtBQUwsQ0FBV3dCLE9BQVgsQ0FBbUJuQixPQUFuQixDQUFWO0FBQ0QsT0FGRCxNQUVPO0FBQ0xtQixrQkFBVXRCLEtBQUtzQixPQUFMLENBQWFuQixPQUFiLENBQVY7QUFDRDs7QUFFRG1CLGNBQVFDLEdBQVIsQ0FBWVosU0FBU1UsSUFBckI7O0FBRUE7QUFDQTtBQUNBLFVBQUlHLGVBQWUsRUFBbkI7O0FBRUFGLGNBQVFHLEVBQVIsQ0FBVyxVQUFYLEVBQXVCLG9CQUFZO0FBQ2pDLFlBQUlDLFdBQ0ZDLFNBQVNwQixPQUFULENBQWlCLGNBQWpCLE1BQXFDLDBCQUR2QztBQUVBLFlBQUksQ0FBQ21CLFFBQUwsRUFBZTtBQUNiQyxtQkFBU0MsV0FBVCxDQUFxQixNQUFyQjtBQUNEOztBQUVERCxpQkFBU0YsRUFBVCxDQUFZLE1BQVosRUFBb0IsaUJBQVM7QUFDM0JELHVCQUFhSyxJQUFiLENBQWtCQyxLQUFsQjtBQUNELFNBRkQ7O0FBSUFILGlCQUFTRixFQUFULENBQVksS0FBWixFQUFtQixZQUFNO0FBQ3ZCLGdCQUFLaEIsTUFBTCxDQUFZVyxJQUFaLENBQWlCLGlCQUFqQixFQUFvQ08sU0FBU0ksVUFBN0M7QUFDQSxjQUFJbEIsUUFBSixFQUFjO0FBQ1osZ0JBQUlhLFFBQUosRUFBYztBQUNaRiw2QkFBZVEsT0FBT0MsTUFBUCxDQUFjVCxZQUFkLENBQWY7QUFDRDs7QUFFRCxrQkFBS1UsZUFBTCxDQUNFUCxRQURGLEVBRUVILFlBRkYsRUFHRWIsU0FBU0MsTUFIWCxFQUlFQyxRQUpGO0FBTUQ7QUFDRixTQWREO0FBZUFjLGlCQUFTRixFQUFULENBQVksT0FBWixFQUFxQixhQUFLO0FBQ3hCLGdCQUFLaEIsTUFBTCxDQUFZMEIsS0FBWixDQUNFLHFEQURGO0FBR0EsZ0JBQUsxQixNQUFMLENBQVkwQixLQUFaLENBQWtCQyxDQUFsQjtBQUNBdkIsbUJBQVN1QixDQUFUO0FBQ0QsU0FORDtBQU9ELE9BakNEO0FBa0NBZCxjQUFRRyxFQUFSLENBQVcsT0FBWCxFQUFvQixhQUFLO0FBQ3ZCLGNBQUtoQixNQUFMLENBQVkwQixLQUFaLENBQWtCLHFEQUFsQjtBQUNBLGNBQUsxQixNQUFMLENBQVkwQixLQUFaLENBQWtCQyxDQUFsQjtBQUNBdkIsaUJBQVN1QixDQUFUO0FBQ0QsT0FKRDtBQUtEOzs7b0NBRWVDLFksRUFBY0MsSSxFQUFNMUIsTSxFQUFRQyxRLEVBQVU7QUFDcEQsVUFBTTBCLGtCQUFrQkQsZ0JBQWdCRSxLQUFoQixJQUF5QkYsZ0JBQWdCTixNQUFqRTtBQUNBLFVBQUksQ0FBQ08sZUFBTCxFQUFzQjtBQUNwQixjQUFNLElBQUlFLEtBQUosQ0FBVSx3Q0FBVixDQUFOO0FBQ0Q7O0FBRUQsVUFBTUMsU0FBU0wsYUFBYU4sVUFBNUI7QUFDQSxVQUFNeEIsVUFBVThCLGFBQWE5QixPQUE3Qjs7QUFFQSxVQUFJb0IsV0FBVyxJQUFmO0FBQ0EsVUFBSVEsUUFBUSxJQUFaOztBQUVBLFVBQUk7QUFDRixZQUFJTyxVQUFVLEdBQWQsRUFBbUI7QUFDakJQLGtCQUFRLEVBQUVRLFNBQVMsY0FBWCxFQUEyQlosWUFBWVcsTUFBdkMsRUFBUjtBQUNELFNBRkQsTUFFTyxJQUNMTCxhQUFhOUIsT0FBYixDQUFxQixjQUFyQixNQUF5QywwQkFEcEMsRUFFTDtBQUNBb0IscUJBQVdXLElBQVg7QUFDRCxTQUpNLE1BSUEsSUFBSUksV0FBVyxHQUFmLEVBQW9CO0FBQ3pCO0FBQ0EsY0FBSSxDQUFDbkMsUUFBUSxhQUFSLENBQUwsRUFBNkI7QUFDM0I7QUFDQSxnQkFBTXFDLG1CQUFtQmhDLFdBQVcsTUFBWCxHQUFvQixPQUFPLENBQTNCLEdBQStCLE9BQU8sQ0FBL0Q7QUFDQUwsb0JBQVEsYUFBUixJQUF5QnFDLGdCQUF6QjtBQUNEO0FBQ0RULGtCQUFRLEVBQUVkLE1BQU1pQixLQUFLTyxJQUFMLENBQVUsRUFBVixDQUFSLEVBQVI7QUFDRCxTQVJNLE1BUUEsSUFBSUgsV0FBVyxHQUFmLEVBQW9CO0FBQ3pCZixxQkFBVyxJQUFYO0FBQ0QsU0FGTSxNQUVBLElBQUllLFVBQVUsR0FBVixJQUFpQkEsU0FBUyxHQUE5QixFQUFtQztBQUN4Q1Asa0JBQVEsRUFBRWQsTUFBTXlCLEtBQUtDLEtBQUwsQ0FBV1QsS0FBS08sSUFBTCxDQUFVLEVBQVYsQ0FBWCxDQUFSLEVBQW1DdEMsZ0JBQW5DLEVBQVI7QUFDRCxTQUZNLE1BRUEsSUFBSUssV0FBVyxRQUFmLEVBQXlCO0FBQzlCZSxxQkFBV21CLEtBQUtDLEtBQUwsQ0FBV1QsS0FBS08sSUFBTCxDQUFVLEVBQVYsQ0FBWCxDQUFYO0FBQ0QsU0FGTSxNQUVBO0FBQ0xsQixxQkFBV1csSUFBWDtBQUNEO0FBQ0YsT0F4QkQsQ0F3QkUsT0FBT1UsVUFBUCxFQUFtQjtBQUNuQixhQUFLdkMsTUFBTCxDQUFZMEIsS0FBWixDQUFrQmEsVUFBbEI7QUFDQSxhQUFLdkMsTUFBTCxDQUFZMEIsS0FBWixDQUNFLDJHQURGO0FBR0EsYUFBSzFCLE1BQUwsQ0FBWTBCLEtBQVosQ0FBa0IsNkJBQWxCO0FBQ0EsYUFBSzFCLE1BQUwsQ0FBWTBCLEtBQVosUUFBc0JHLElBQXRCOztBQUVBSCxnQkFBUTtBQUNOTyxrQkFBUUEsTUFERjtBQUVOQyxtQkFBUyx1Q0FGSDtBQUdOdEIsZ0JBQU1pQixLQUFLTyxJQUFMLENBQVUsRUFBVixDQUhBO0FBSU5HLHNCQUFZQTtBQUpOLFNBQVI7QUFNRDs7QUFFRCxVQUFJYixLQUFKLEVBQVc7QUFDVEEsY0FBTUosVUFBTixHQUFtQlcsTUFBbkI7QUFDQVAsY0FBTTVCLE9BQU4sR0FBZ0JBLE9BQWhCO0FBQ0Q7O0FBRUQsVUFBSSxPQUFPTSxRQUFQLEtBQW9CLFVBQXhCLEVBQW9DO0FBQ2xDQSxpQkFBU3NCLEtBQVQsRUFBZ0JSLFFBQWhCO0FBQ0Q7QUFDRjs7O3FEQUVnQ2QsUSxFQUFVb0MsbUIsRUFBcUI7QUFDOUQsYUFBTyxVQUFTQyxHQUFULEVBQWNaLElBQWQsRUFBb0I7QUFDekIsWUFBSVksT0FBT0EsSUFBSVIsTUFBSixJQUFjTyxtQkFBekIsRUFBOEM7QUFDNUNDLGNBQUlDLE1BQUosR0FDRSx3R0FERjtBQUVEOztBQUVELGVBQU90QyxTQUFTcUMsR0FBVCxFQUFjWixJQUFkLENBQVA7QUFDRCxPQVBEO0FBUUQ7Ozt3QkFFR3hCLEksRUFBTXNDLE0sRUFBUXZDLFEsRUFBVTtBQUMxQnVDLGVBQVNBLFVBQVUsRUFBbkI7QUFDQUEsYUFBTyxTQUFQLElBQW9CLEtBQUtoRCxXQUFMLENBQWlCaUQsTUFBckM7QUFDQUQsYUFBTyxZQUFQLElBQXVCLEtBQUtoRCxXQUFMLENBQWlCa0QsU0FBeEM7O0FBRUF4QyxhQUFPQSxPQUFPLEdBQVAsR0FBYWIsWUFBWXNELFNBQVosQ0FBc0JILE1BQXRCLENBQXBCOztBQUVBLFdBQUs5QixPQUFMLENBQWEsRUFBRVIsTUFBTUEsSUFBUixFQUFiLEVBQTZCLEtBQTdCLEVBQW9DRCxRQUFwQztBQUNEOzs7eUJBRUlDLEksRUFBTXNDLE0sRUFBUXZDLFEsRUFBVTtBQUMzQixVQUFJMkMsS0FBSztBQUNQQyxpQkFBUyxLQUFLckQsV0FBTCxDQUFpQmlELE1BRG5CO0FBRVBLLG9CQUFZLEtBQUt0RCxXQUFMLENBQWlCa0Q7QUFGdEIsT0FBVDs7QUFLQSxVQUFJSyxXQUFXLEdBQWY7QUFDQSxVQUFJN0MsS0FBSzhDLE9BQUwsQ0FBYUQsUUFBYixNQUEyQixDQUFDLENBQWhDLEVBQW1DO0FBQ2pDQSxtQkFBVyxHQUFYO0FBQ0Q7O0FBRUQ3QyxhQUFPQSxPQUFPNkMsUUFBUCxHQUFrQjFELFlBQVlzRCxTQUFaLENBQXNCQyxFQUF0QixDQUF6Qjs7QUFFQSxXQUFLbEMsT0FBTCxDQUNFLEVBQUVSLE1BQU1BLElBQVIsRUFBY08sTUFBTXBCLFlBQVlzRCxTQUFaLENBQXNCSCxNQUF0QixDQUFwQixFQURGLEVBRUUsTUFGRixFQUdFdkMsUUFIRjtBQUtEOzs7dUNBRWtCQyxJLEVBQU1zQyxNLEVBQVF2QyxRLEVBQVU7QUFDekN1QyxlQUFTQSxVQUFVLEVBQW5CO0FBQ0FBLGFBQU8sU0FBUCxJQUFvQixLQUFLaEQsV0FBTCxDQUFpQmlELE1BQXJDO0FBQ0FELGFBQU8sWUFBUCxJQUF1QixLQUFLaEQsV0FBTCxDQUFpQmtELFNBQXhDOztBQUVBeEMsYUFBT0EsT0FBTyxHQUFQLEdBQWFiLFlBQVlzRCxTQUFaLENBQXNCSCxNQUF0QixDQUFwQjs7QUFFQSxXQUFLOUIsT0FBTCxDQUFhLEVBQUVSLE1BQU1BLElBQVIsRUFBYixFQUE2QixNQUE3QixFQUFxQ0QsUUFBckM7QUFDRDs7Ozs7O2tCQUdZWCxVIiwiZmlsZSI6Ikh0dHBDbGllbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgaHR0cHMgPSByZXF1aXJlKFwiaHR0cHNcIik7XG52YXIgaHR0cCA9IHJlcXVpcmUoXCJodHRwXCIpO1xudmFyIHF1ZXJ5c3RyaW5nID0gcmVxdWlyZShcInF1ZXJ5c3RyaW5nXCIpO1xuXG5jbGFzcyBIdHRwQ2xpZW50IHtcbiAgY29uc3RydWN0b3Iob3B0aW9ucywgY3JlZGVudGlhbHMpIHtcbiAgICB0aGlzLmNyZWRlbnRpYWxzID0gY3JlZGVudGlhbHM7XG4gICAgdGhpcy5ob3N0ID0gb3B0aW9ucy5ob3N0IHx8IFwicmVzdC5uZXhtby5jb21cIjtcbiAgICB0aGlzLnBvcnQgPSBvcHRpb25zLnBvcnQgfHwgNDQzO1xuICAgIHRoaXMuaHR0cHMgPSBvcHRpb25zLmh0dHBzIHx8IGh0dHBzO1xuICAgIHRoaXMuaHR0cCA9IG9wdGlvbnMuaHR0cCB8fCBodHRwO1xuICAgIHRoaXMuaGVhZGVycyA9IHtcbiAgICAgIFwiQ29udGVudC1UeXBlXCI6IFwiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkXCIsXG4gICAgICBBY2NlcHQ6IFwiYXBwbGljYXRpb24vanNvblwiXG4gICAgfTtcbiAgICB0aGlzLmxvZ2dlciA9IG9wdGlvbnMubG9nZ2VyO1xuXG4gICAgaWYgKG9wdGlvbnMudXNlckFnZW50KSB7XG4gICAgICB0aGlzLmhlYWRlcnNbXCJVc2VyLUFnZW50XCJdID0gb3B0aW9ucy51c2VyQWdlbnQ7XG4gICAgfVxuICB9XG5cbiAgcmVxdWVzdChlbmRwb2ludCwgbWV0aG9kLCBjYWxsYmFjaykge1xuICAgIGlmICh0eXBlb2YgbWV0aG9kID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIGNhbGxiYWNrID0gbWV0aG9kO1xuICAgICAgZW5kcG9pbnQubWV0aG9kID0gZW5kcG9pbnQubWV0aG9kIHx8IFwiR0VUXCI7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgbWV0aG9kICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICBlbmRwb2ludC5tZXRob2QgPSBtZXRob2Q7XG4gICAgfVxuXG4gICAgaWYgKGVuZHBvaW50Lm1ldGhvZCA9PT0gXCJQT1NUXCIgfHwgZW5kcG9pbnQubWV0aG9kID09PSBcIkRFTEVURVwiKSB7XG4gICAgICAvLyBUT0RPOiB2ZXJpZnkgdGhlIGZvbGxvd2luZyBmaXggaXMgcmVxdWlyZWRcbiAgICAgIC8vIEZpeCBicm9rZW4gZHVlIG90IDQxMSBDb250ZW50LUxlbmd0aCBlcnJvciBub3cgc2VudCBieSBOZXhtbyBBUElcbiAgICAgIC8vIFBMIDIwMTYtU2VwdC02IC0gY29tbWVudGVkIG91dCBDb250ZW50LUxlbmd0aCAwXG4gICAgICAvLyBoZWFkZXJzWydDb250ZW50LUxlbmd0aCddID0gMDtcbiAgICB9XG4gICAgdmFyIG9wdGlvbnMgPSB7XG4gICAgICBob3N0OiBlbmRwb2ludC5ob3N0ID8gZW5kcG9pbnQuaG9zdCA6IHRoaXMuaG9zdCxcbiAgICAgIHBvcnQ6IHRoaXMucG9ydCxcbiAgICAgIHBhdGg6IGVuZHBvaW50LnBhdGgsXG4gICAgICBtZXRob2Q6IGVuZHBvaW50Lm1ldGhvZCxcbiAgICAgIGhlYWRlcnM6IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuaGVhZGVycylcbiAgICB9O1xuXG4gICAgLy8gQWxsb3cgZXhpc3RpbmcgaGVhZGVycyB0byBiZSBvdmVycmlkZGVuXG4gICAgLy8gQWxsb3cgbmV3IGhlYWRlcnMgdG8gYmUgYWRkZWRcbiAgICBpZiAoZW5kcG9pbnQuaGVhZGVycykge1xuICAgICAgT2JqZWN0LmtleXMoZW5kcG9pbnQuaGVhZGVycykuZm9yRWFjaChmdW5jdGlvbihrZXkpIHtcbiAgICAgICAgb3B0aW9ucy5oZWFkZXJzW2tleV0gPSBlbmRwb2ludC5oZWFkZXJzW2tleV07XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB0aGlzLmxvZ2dlci5pbmZvKFwiUmVxdWVzdDpcIiwgb3B0aW9ucywgXCJcXG5Cb2R5OlwiLCBlbmRwb2ludC5ib2R5KTtcbiAgICB2YXIgcmVxdWVzdDtcblxuICAgIGlmIChvcHRpb25zLnBvcnQgPT09IDQ0Mykge1xuICAgICAgcmVxdWVzdCA9IHRoaXMuaHR0cHMucmVxdWVzdChvcHRpb25zKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmVxdWVzdCA9IGh0dHAucmVxdWVzdChvcHRpb25zKTtcbiAgICB9XG5cbiAgICByZXF1ZXN0LmVuZChlbmRwb2ludC5ib2R5KTtcblxuICAgIC8vIEtlZXAgYW4gYXJyYXkgb2YgU3RyaW5nIG9yIEJ1ZmZlcnMsXG4gICAgLy8gZGVwZW5kaW5nIG9uIGNvbnRlbnQgdHlwZSAoYmluYXJ5IG9yIEpTT04pIG9mIHJlc3BvbnNlXG4gICAgdmFyIHJlc3BvbnNlRGF0YSA9IFtdO1xuXG4gICAgcmVxdWVzdC5vbihcInJlc3BvbnNlXCIsIHJlc3BvbnNlID0+IHtcbiAgICAgIHZhciBpc0JpbmFyeSA9XG4gICAgICAgIHJlc3BvbnNlLmhlYWRlcnNbXCJjb250ZW50LXR5cGVcIl0gPT09IFwiYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtXCI7XG4gICAgICBpZiAoIWlzQmluYXJ5KSB7XG4gICAgICAgIHJlc3BvbnNlLnNldEVuY29kaW5nKFwidXRmOFwiKTtcbiAgICAgIH1cblxuICAgICAgcmVzcG9uc2Uub24oXCJkYXRhXCIsIGNodW5rID0+IHtcbiAgICAgICAgcmVzcG9uc2VEYXRhLnB1c2goY2h1bmspO1xuICAgICAgfSk7XG5cbiAgICAgIHJlc3BvbnNlLm9uKFwiZW5kXCIsICgpID0+IHtcbiAgICAgICAgdGhpcy5sb2dnZXIuaW5mbyhcInJlc3BvbnNlIGVuZGVkOlwiLCByZXNwb25zZS5zdGF0dXNDb2RlKTtcbiAgICAgICAgaWYgKGNhbGxiYWNrKSB7XG4gICAgICAgICAgaWYgKGlzQmluYXJ5KSB7XG4gICAgICAgICAgICByZXNwb25zZURhdGEgPSBCdWZmZXIuY29uY2F0KHJlc3BvbnNlRGF0YSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdGhpcy5fX3BhcnNlUmVzcG9uc2UoXG4gICAgICAgICAgICByZXNwb25zZSxcbiAgICAgICAgICAgIHJlc3BvbnNlRGF0YSxcbiAgICAgICAgICAgIGVuZHBvaW50Lm1ldGhvZCxcbiAgICAgICAgICAgIGNhbGxiYWNrXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICByZXNwb25zZS5vbihcImNsb3NlXCIsIGUgPT4ge1xuICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgICBcInByb2JsZW0gd2l0aCBBUEkgcmVxdWVzdCBkZXRhaWxlZCBzdGFja3RyYWNlIGJlbG93IFwiXG4gICAgICAgICk7XG4gICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGUpO1xuICAgICAgICBjYWxsYmFjayhlKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIHJlcXVlc3Qub24oXCJlcnJvclwiLCBlID0+IHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFwicHJvYmxlbSB3aXRoIEFQSSByZXF1ZXN0IGRldGFpbGVkIHN0YWNrdHJhY2UgYmVsb3cgXCIpO1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoZSk7XG4gICAgICBjYWxsYmFjayhlKTtcbiAgICB9KTtcbiAgfVxuXG4gIF9fcGFyc2VSZXNwb25zZShodHRwUmVzcG9uc2UsIGRhdGEsIG1ldGhvZCwgY2FsbGJhY2spIHtcbiAgICBjb25zdCBpc0FycmF5T3JCdWZmZXIgPSBkYXRhIGluc3RhbmNlb2YgQXJyYXkgfHwgZGF0YSBpbnN0YW5jZW9mIEJ1ZmZlcjtcbiAgICBpZiAoIWlzQXJyYXlPckJ1ZmZlcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiZGF0YSBzaG91bGQgYmUgb2YgdHlwZSBBcnJheSBvciBCdWZmZXJcIik7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RhdHVzID0gaHR0cFJlc3BvbnNlLnN0YXR1c0NvZGU7XG4gICAgY29uc3QgaGVhZGVycyA9IGh0dHBSZXNwb25zZS5oZWFkZXJzO1xuXG4gICAgbGV0IHJlc3BvbnNlID0gbnVsbDtcbiAgICB2YXIgZXJyb3IgPSBudWxsO1xuXG4gICAgdHJ5IHtcbiAgICAgIGlmIChzdGF0dXMgPj0gNTAwKSB7XG4gICAgICAgIGVycm9yID0geyBtZXNzYWdlOiBcIlNlcnZlciBFcnJvclwiLCBzdGF0dXNDb2RlOiBzdGF0dXMgfTtcbiAgICAgIH0gZWxzZSBpZiAoXG4gICAgICAgIGh0dHBSZXNwb25zZS5oZWFkZXJzW1wiY29udGVudC10eXBlXCJdID09PSBcImFwcGxpY2F0aW9uL29jdGV0LXN0cmVhbVwiXG4gICAgICApIHtcbiAgICAgICAgcmVzcG9uc2UgPSBkYXRhO1xuICAgICAgfSBlbHNlIGlmIChzdGF0dXMgPT09IDQyOSkge1xuICAgICAgICAvLyA0MjkgZG9lcyBub3QgcmV0dXJuIGEgcGFyc2FibGUgYm9keVxuICAgICAgICBpZiAoIWhlYWRlcnNbXCJyZXRyeS1hZnRlclwiXSkge1xuICAgICAgICAgIC8vIHJldHJ5IGJhc2VkIG9uIGFsbG93ZWQgcGVyIHNlY29uZFxuICAgICAgICAgIGNvbnN0IHJldHJ5QWZ0ZXJNaWxsaXMgPSBtZXRob2QgPT09IFwiUE9TVFwiID8gMTAwMCAvIDIgOiAxMDAwIC8gNTtcbiAgICAgICAgICBoZWFkZXJzW1wicmV0cnktYWZ0ZXJcIl0gPSByZXRyeUFmdGVyTWlsbGlzO1xuICAgICAgICB9XG4gICAgICAgIGVycm9yID0geyBib2R5OiBkYXRhLmpvaW4oXCJcIikgfTtcbiAgICAgIH0gZWxzZSBpZiAoc3RhdHVzID09PSAyMDQpIHtcbiAgICAgICAgcmVzcG9uc2UgPSBudWxsO1xuICAgICAgfSBlbHNlIGlmIChzdGF0dXMgPj0gNDAwIHx8IHN0YXR1cyA8IDIwMCkge1xuICAgICAgICBlcnJvciA9IHsgYm9keTogSlNPTi5wYXJzZShkYXRhLmpvaW4oXCJcIikpLCBoZWFkZXJzIH07XG4gICAgICB9IGVsc2UgaWYgKG1ldGhvZCAhPT0gXCJERUxFVEVcIikge1xuICAgICAgICByZXNwb25zZSA9IEpTT04ucGFyc2UoZGF0YS5qb2luKFwiXCIpKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJlc3BvbnNlID0gZGF0YTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChwYXJzZUVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihwYXJzZUVycm9yKTtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFxuICAgICAgICBcImNvdWxkIG5vdCBjb252ZXJ0IEFQSSByZXNwb25zZSB0byBKU09OLCBhYm92ZSBlcnJvciBpcyBpZ25vcmVkIGFuZCByYXcgQVBJIHJlc3BvbnNlIGlzIHJldHVybmVkIHRvIGNsaWVudFwiXG4gICAgICApO1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXCJSYXcgRXJyb3IgbWVzc2FnZSBmcm9tIEFQSSBcIik7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihgXCIke2RhdGF9XCJgKTtcblxuICAgICAgZXJyb3IgPSB7XG4gICAgICAgIHN0YXR1czogc3RhdHVzLFxuICAgICAgICBtZXNzYWdlOiBcIlRoZSBBUEkgcmVzcG9uc2UgY291bGQgbm90IGJlIHBhcnNlZC5cIixcbiAgICAgICAgYm9keTogZGF0YS5qb2luKFwiXCIpLFxuICAgICAgICBwYXJzZUVycm9yOiBwYXJzZUVycm9yXG4gICAgICB9O1xuICAgIH1cblxuICAgIGlmIChlcnJvcikge1xuICAgICAgZXJyb3Iuc3RhdHVzQ29kZSA9IHN0YXR1cztcbiAgICAgIGVycm9yLmhlYWRlcnMgPSBoZWFkZXJzO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2YgY2FsbGJhY2sgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgY2FsbGJhY2soZXJyb3IsIHJlc3BvbnNlKTtcbiAgICB9XG4gIH1cblxuICBfYWRkTGltaXRlZEFjY2Vzc01lc3NhZ2VUb0Vycm9ycyhjYWxsYmFjaywgbGltaXRlZEFjY2Vzc1N0YXR1cykge1xuICAgIHJldHVybiBmdW5jdGlvbihlcnIsIGRhdGEpIHtcbiAgICAgIGlmIChlcnIgJiYgZXJyLnN0YXR1cyA9PSBsaW1pdGVkQWNjZXNzU3RhdHVzKSB7XG4gICAgICAgIGVyci5fSU5GT18gPVxuICAgICAgICAgIFwiVGhpcyBlbmRwb2ludCBtYXkgbmVlZCBhY3RpdmF0aW5nIG9uIHlvdXIgYWNjb3VudC4gUGxlYXNlIGVtYWlsIHN1cHBvcnRAbmV4bW8uY29tIGZvciBtb3JlIGluZm9ybWF0aW9uXCI7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBjYWxsYmFjayhlcnIsIGRhdGEpO1xuICAgIH07XG4gIH1cblxuICBnZXQocGF0aCwgcGFyYW1zLCBjYWxsYmFjaykge1xuICAgIHBhcmFtcyA9IHBhcmFtcyB8fCB7fTtcbiAgICBwYXJhbXNbXCJhcGlfa2V5XCJdID0gdGhpcy5jcmVkZW50aWFscy5hcGlLZXk7XG4gICAgcGFyYW1zW1wiYXBpX3NlY3JldFwiXSA9IHRoaXMuY3JlZGVudGlhbHMuYXBpU2VjcmV0O1xuXG4gICAgcGF0aCA9IHBhdGggKyBcIj9cIiArIHF1ZXJ5c3RyaW5nLnN0cmluZ2lmeShwYXJhbXMpO1xuXG4gICAgdGhpcy5yZXF1ZXN0KHsgcGF0aDogcGF0aCB9LCBcIkdFVFwiLCBjYWxsYmFjayk7XG4gIH1cblxuICBwb3N0KHBhdGgsIHBhcmFtcywgY2FsbGJhY2spIHtcbiAgICBsZXQgcXMgPSB7XG4gICAgICBhcGlfa2V5OiB0aGlzLmNyZWRlbnRpYWxzLmFwaUtleSxcbiAgICAgIGFwaV9zZWNyZXQ6IHRoaXMuY3JlZGVudGlhbHMuYXBpU2VjcmV0XG4gICAgfTtcblxuICAgIGxldCBqb2luQ2hhciA9IFwiP1wiO1xuICAgIGlmIChwYXRoLmluZGV4T2Yoam9pbkNoYXIpICE9PSAtMSkge1xuICAgICAgam9pbkNoYXIgPSBcIiZcIjtcbiAgICB9XG5cbiAgICBwYXRoID0gcGF0aCArIGpvaW5DaGFyICsgcXVlcnlzdHJpbmcuc3RyaW5naWZ5KHFzKTtcblxuICAgIHRoaXMucmVxdWVzdChcbiAgICAgIHsgcGF0aDogcGF0aCwgYm9keTogcXVlcnlzdHJpbmcuc3RyaW5naWZ5KHBhcmFtcykgfSxcbiAgICAgIFwiUE9TVFwiLFxuICAgICAgY2FsbGJhY2tcbiAgICApO1xuICB9XG5cbiAgcG9zdFVzZVF1ZXJ5U3RyaW5nKHBhdGgsIHBhcmFtcywgY2FsbGJhY2spIHtcbiAgICBwYXJhbXMgPSBwYXJhbXMgfHwge307XG4gICAgcGFyYW1zW1wiYXBpX2tleVwiXSA9IHRoaXMuY3JlZGVudGlhbHMuYXBpS2V5O1xuICAgIHBhcmFtc1tcImFwaV9zZWNyZXRcIl0gPSB0aGlzLmNyZWRlbnRpYWxzLmFwaVNlY3JldDtcblxuICAgIHBhdGggPSBwYXRoICsgXCI/XCIgKyBxdWVyeXN0cmluZy5zdHJpbmdpZnkocGFyYW1zKTtcblxuICAgIHRoaXMucmVxdWVzdCh7IHBhdGg6IHBhdGggfSwgXCJQT1NUXCIsIGNhbGxiYWNrKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBIdHRwQ2xpZW50O1xuIl19